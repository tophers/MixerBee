<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>MixerBee</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="stylesheet" href="static/css/main.css">
    <link rel="icon" type="image/svg+xml" href="static/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet">
    <script src="static/js/header.js"></script>
</head>
<body>
    <select id="user-select" class="hidden"></select>

    <div class="main-header-bar">
        <div class="header-user-display">
            <i data-feather="user"></i>
            <span id="active-user-display"></span>
            <div class="theme-switcher">
                <label for="theme-toggle-cb" class="theme-toggle-label">
                    <i data-feather="moon"></i>
                    <input type="checkbox" id="theme-toggle-cb">
                    <span class="slider"></span>
                    <i data-feather="sun"></i>
                </label>
            </div>

            <button id="settings-btn" type="button" class="icon-btn" title="Settings"><i data-feather="settings"></i></button>
        </div>
    </div>

    <div id="typewriter-overlay">
        <div class="typewriter-wrapper">
          <h2 class="typewriter-header">
            <span id="typed-text"></span>
          </h2>
        </div>
    </div>

    <div class="tab-switcher">
        <button id="mixed-tab-btn" class="tab-btn active">Builder</button>
        <button id="scheduler-tab-btn" class="tab-btn">Scheduler</button>
        <button id="manager-tab-btn" class="tab-btn">Manager</button>
    </div>

    <div id="not-configured-warning" class="container">
         <div class="warning-box">
             <i data-feather="alert-triangle"></i>
             <h3>Application Not Configured</h3>
             <p>MixerBee can't connect to your server. Please open the settings and provide your server details, or check if the server is running.</p>
             <button id="not-configured-settings-btn">Open Settings</button>
         </div>
    </div>

    <div id="main-content-area" class="hidden">
        <div id="mixed-pane" class="tab-pane active">
            <div class="container">
                <div class="preset-controls">
                    <label class="control-item" for="load-preset-select">
                        <span>Load Preset</span>
                        <select id="load-preset-select">
                            <option value="">-- Select a preset --</option>
                        </select>
                    </label>
                    <div class="preset-buttons button-group">
                        <button id="update-preset-btn" type="button" class="hidden">Save</button>
                        <button id="save-as-preset-btn" type="button" class="secondary">Save as Preset...</button>
                        <button id="delete-preset-btn" type="button" class="secondary">Delete Preset</button>
                        <button id="import-preset-btn" type="button" class="secondary">Import</button>
                        <button id="export-preset-btn" type="button" class="secondary" disabled>Export</button>
                    </div>
                </div>
                 <fieldset id="ai-generator-container" class="filter-group hidden">
                    <legend>AI Block Builder</legend>
                    <details>
                        <summary>Expand AI Block Builder</summary>
                        <div class="textarea-wrapper">
                            <textarea id="ai-prompt-input" rows="2" placeholder="e.g., A block of 80s action movies followed by some episodes of Star Trek TNG and The Orville"></textarea>
                            <button type="button" id="ai-prompt-clear-btn" class="icon-btn clear-btn hidden" title="Clear text"><i data-feather="x-circle"></i></button>
                        </div>
                        <div class="button-group" style="justify-content: flex-end;">
                            <button id="generate-with-ai-btn" type="button" class="secondary">Generate with AI</button>
                        </div>
                    </details>
                </fieldset>

                <div id="mixed-playlist-blocks">
                    <p class="placeholder-text">Click <strong>'Add Block'</strong> below to begin building your mix, <br> or try <strong>'Auto Playlists'</strong> for a quick start.</p>
                </div>
                <div id="add-block-controls" class="button-group">
                    <div class="dropdown-container">
                        <button id="add-block-btn" class="secondary"><i data-feather="plus"></i> Add Block <i data-feather="chevron-down" class="chevron"></i></button>
                        <div id="add-block-menu" class="dropdown-menu hidden">
                            <a href="#" class="dropdown-item" data-block-type="tv"><i data-feather="tv"></i> TV Block</a>
                            <a href="#" class="dropdown-item" data-block-type="movie"><i data-feather="film"></i> Movie Block</a>
                            <a href="#" class="dropdown-item" data-block-type="music"><i data-feather="music"></i> Music Block</a>
                        </div>
                    </div>
                    <button id="smart-build-btn" type="button" class="secondary"><i data-feather="framer"></i> Auto Playlists</button>
                    <button id="clear-all-blocks-btn" type="button" class="secondary" style="margin-left: auto;">Clear All Blocks</button>
                </div>
            </div>
        </div>

        <div id="scheduler-pane" class="tab-pane hidden">
            <div class="container">
                <details class="collapsible-section" open>
                    <summary class="collapsible-section-header">
                        <h3><i data-feather="plus-circle"></i> Create a New Schedule</h3>
                        <span class="icon-btn collapse-toggle-btn">
                            <i data-feather="chevron-up"></i>
                        </span>
                    </summary>
                    <div class="collapsible-section-body">
                        <fieldset class="filter-group">
                            <legend>Schedule Details</legend>
                            <div class="scheduler-grid">
                                <label class="control-item">
                                    <span>Playlist Name</span>
                                    <input type="text" id="schedule-playlist-name" value="Scheduled">
                                </label>
                                <label class="control-item">
                                    <span>Schedule Source</span>
                                    <select id="schedule-source-select">
                                        <option value="builder">From Builder Preset</option>
                                        <option value="quick_playlist">From Auto Playlists</option>
                                    </select>
                                </label>
                            </div>
                            <div id="schedule-builder-options" class="scheduler-source-options">
                                <label class="control-item">
                                    <span>Preset to Schedule</span>
                                    <select id="schedule-preset-select">
                                        <option value="">-- Select a saved preset --</option>
                                    </select>
                                </label>
                            </div>
                            <div id="schedule-quick-options" class="scheduler-source-options hidden">
                                 <div class="scheduler-grid">
                                    <label class="control-item">
                                        <span>Auto Playlist Type</span>
                                        <select id="schedule-quick-type-select"></select>
                                    </label>
                                    <label class="control-item">
                                        <span>Number of Items</span>
                                        <input type="number" id="schedule-quick-count-input" value="10" min="1">
                                    </label>
                                </div>
                            </div>
                        </fieldset>
                        <fieldset class="filter-group">
                            <legend>Schedule Time</legend>
                            <div class="scheduler-grid">
                                 <label class="control-item">
                                    <span>Frequency</span>
                                    <select id="schedule-frequency">
                                        <option value="daily">Daily</option>
                                        <option value="weekly">Weekly</option>
                                    </select>
                                </label>
                                <label class="control-item">
                                    <span>Run At</span>
                                    <input type="time" id="schedule-time-input" value="19:00">
                                </label>
                            </div>
                             <div id="schedule-days-container" class="checkbox-grid hidden" style="margin-top: 1rem;">
                                <label><input type="checkbox" name="schedule-day" value="1"> Mon</label>
                                <label><input type="checkbox" name="schedule-day" value="2"> Tue</label>
                                <label><input type="checkbox" name="schedule-day" value="3"> Wed</label>
                                <label><input type="checkbox" name="schedule-day" value="4"> Thu</label>
                                <label><input type="checkbox" name="schedule-day" value="5"> Fri</label>
                                <label><input type="checkbox" name="schedule-day" value="6"> Sat</label>
                                <label><input type="checkbox" name="schedule-day" value="0"> Sun</label>
                            </div>
                        </fieldset>
                        <div class="button-group" style="justify-content: flex-end; margin-top: 1rem;">
                            <button id="create-schedule-btn" class="secondary">Create Schedule</button>
                        </div>
                    </div>
                </details>

                <details id="schedules-list-container" class="collapsible-section hidden" open>
                    <summary class="collapsible-section-header">
                        <h3><i data-feather="list"></i> Active Schedules <span id="schedule-count"></span></h3>
                        <span class="icon-btn collapse-toggle-btn">
                            <i data-feather="chevron-up"></i>
                        </span>
                    </summary>
                    <div class="collapsible-section-body no-padding">
                        <ul id="schedules-list">
                        </ul>
                    </div>
                </details>
            </div>
        </div>
        <div id="manager-pane" class="tab-pane hidden">
          <div class="container">
           <details class="collapsible-section" open>
            <summary class="collapsible-section-header">
                <h3><i data-feather="folder"></i> Manage Playlists & Collections</h3>
                <span class="icon-btn collapse-toggle-btn">
                    <i data-feather="chevron-up"></i>
                </span>
            </summary>
            <div class="collapsible-section-body no-padding">
                <input type="search" id="manager-search-input" placeholder="Filter by name..." style="width: 100%; margin: 0 0 1rem 0; padding-left: 1.2rem; padding-right: 1.2rem; box-sizing: border-box;">
                      <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th class="sortable sort-asc" data-sort="Name">Name</th>
                                        <th class="sortable" data-sort="DisplayType">Type</th>
                                        <th class="sortable" data-sort="ItemCount">Items</th>
                                        <th class="sortable" data-sort="DateCreated">Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </details>
            </div>
        </div>
    </div>


    <div id="action-bar" class="hidden">
        <div class="action-bar-content">
            <div class="build-options-container">
                <select id="build-mode-select">
                    <option value="create">Create New</option>
                    <option value="add">Add to Existing</option>
                </select>
                <select id="existing-playlist-select" class="hidden">
                </select>
            </div>
            <button id="generate-mixed-playlist-btn">Build</button>
            <label class="action-bar-checkbox-label">
                <input type="checkbox" id="create-as-collection-cb">
                <span>Create as Collection</span>
            </label>
        </div>
    </div>

    <div id="settings-modal-overlay" class="modal-overlay hidden">
        <div class="modal-window">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="icon-btn js-modal-close">×</button>
            </div>
            <div class="modal-body">
                <p>Enter your server details. The page will reload automatically to apply your changes.</p>
                <div class="modal-form-layout">
                    <label class="control-item">
                        <span>Server Type</span>
                        <select id="settings-server-type-select">
                          <option value="emby">Emby</option>
                          <option value="jellyfin">Jellyfin</option>
                        </select>
                    </label>
                    <label class="control-item">
                        <span>Server URL</span>
                        <input type="text" id="settings-url-input" placeholder="e.g., http://localhost:8096">
                    </label>
                    <label class="control-item">
                        <span>Username</span>
                        <input type="text" id="settings-user-input" placeholder="Your username">
                    </label>
                    <label class="control-item">
                        <span>Password</span>
                        <input type="password" id="settings-pass-input" placeholder="Your password">
                    </label>
                    <label class="control-item">
                        <span>Gemini API Key (Optional)</span>
                        <input type="password" id="settings-gemini-input" placeholder="Google Gemini API Key">
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button id="settings-test-btn" type="button" class="secondary mr-auto">Test Current Connection</button>
                <button type="button" class="secondary js-modal-cancel">Cancel</button>
                <button id="settings-save-btn" type="button">Save</button>
            </div>
        </div>
    </div>

    <div id="save-preset-modal-overlay" class="modal-overlay hidden">
        <div class="modal-window">
            <div class="modal-header">
                <h2>Save Preset</h2>
                <button class="icon-btn js-modal-close">×</button>
            </div>
            <div class="modal-body">
                <label for="preset-name-input" style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Preset Name</label>
                <input type="text" id="preset-name-input" placeholder="e.g., Sci-Fi Favorites" style="width: 100%; box-sizing: border-box;">
                <div id="preset-overwrite-warning" style="color: var(--danger); font-size: 0.9em; margin-top: 0.5rem; display: none;">
                    Warning: A preset with this name already exists. Saving will overwrite it.
                </div>
            </div>
            <div class="modal-footer">
                <button id="save-preset-confirm-btn" type="button">Save</button>
            </div>
        </div>
    </div>

    <div id="smart-playlist-modal-overlay" class="modal-overlay hidden">
        <div class="modal-window">
            <div class="modal-header">
                <h2 id="smart-playlist-title">Create Playlist</h2>
                <button class="icon-btn js-modal-close">×</button>
            </div>
            <div class="modal-body">
                <p id="smart-playlist-description"></p>
                <div class="modal-form-layout">
                    <label class="control-item">
                        <span>Playlist Name</span>
                        <input type="text" id="smart-playlist-name-input">
                    </label>
                    <label class="control-item" id="smart-playlist-count-wrapper">
                        <span id="smart-playlist-count-label">Number of Items</span>
                        <input type="number" id="smart-playlist-count-input" min="1" value="10">
                    </label>
                </div>
            </div>
            <div class="modal-footer">
               <button id="smart-playlist-confirm-btn" type="button">Create</button>
            </div>
        </div>
    </div>

    <div id="import-preset-modal-overlay" class="modal-overlay hidden">
        <div class="modal-window">
            <div class="modal-header">
                <h2>Import Preset</h2>
                <button class="icon-btn js-modal-close">×</button>
            </div>
            <div class="modal-body">
                <div class="modal-form-layout">
                    <label class="control-item">
                        <span>Share Code</span>
                        <textarea id="import-code-input" rows="4" placeholder="Paste share code here..."></textarea>
                    </label>
                    <label class="control-item">
                        <span>New Preset Name</span>
                        <input type="text" id="import-name-input" placeholder="e.g., Friend's Movie Mix">
                    </label>
                </div>
            </div>
            <div class="modal-footer">
               <button id="import-preset-confirm-btn" type="button">Import</button>
            </div>
        </div>
    </div>

    <div id="smart-build-modal-overlay" class="modal-overlay hidden">
        <div class="modal-window">
            <div class="modal-header">
                <h2>Build an Auto Playlist</h2>
                <button class="icon-btn js-modal-close">×</button>
            </div>
            <div class="modal-body">
                <p>Select a pre-configured playlist type to create.</p>
                <ul id="smart-build-list" class="item-selection-list">
                </ul>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>

    <div id="contents-modal-overlay" class="modal-overlay hidden">
        <div class="modal-window">
            <div class="modal-header">
                <h2 id="contents-modal-title">Contents</h2>
                <button class="icon-btn js-modal-close">×</button>
            </div>
            <div class="modal-body" id="contents-modal-body">
            </div>
            <div class="modal-footer">
                <button id="contents-modal-ok-btn" type="button">OK</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal-overlay" class="modal-overlay hidden">
        <div class="modal-window">
            <div class="modal-header">
                <h2 id="confirm-modal-title">Are you sure?</h2>
                <button class="icon-btn js-modal-close">×</button>
            </div>
            <div class="modal-body">
                <p id="confirm-modal-text">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button id="confirm-modal-confirm-btn" type="button" class="danger">Confirm</button>
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
    </div>

    <!-- ========= COMPONENT TEMPLATES ========= -->
    <template id="template-tv-block">
        <details class="mixed-block" data-type="tv" open>
            <summary>
                <div class="mixed-block-header">
                    <button type="button" class="icon-btn drag-handle" title="Drag to reorder"><i data-feather="move"></i></button>
                    <h3><i data-feather="tv"></i> TV Block</h3>
                    <div class="mixed-block-controls">
                        <span class="tv-block-preview-summary"></span>
                        <button type="button" class="icon-btn duplicate-block-btn" title="Duplicate Block"><i data-feather="copy"></i></button>
                        <button type="button" class="icon-btn danger delete-block-btn" title="Delete Block"><i data-feather="x"></i></button>
                        <span class="icon-btn collapse-toggle-btn"><i data-feather="chevron-up"></i></span>
                    </div>
                </div>
            </summary>
            <div class="mixed-block-body">
                <div class="tv-block-shows">
                    <!-- TV Show Rows will be inserted here -->
                </div>
                <div class="button-group">
                    <button type="button" class="secondary add-show-row-btn"><i data-feather="plus"></i> Add Show</button>
                </div>
                <div class="block-options-footer">
                    <div class="block-options-grid">
                        <label>Mode:
                            <select class="tv-block-mode-select">
                                <option value="count">By Episode Count</option>
                                <option value="range">By End Episode</option>
                            </select>
                        </label>
                        <div class="tv-block-count-container">
                            <label>Episodes per show:
                                <input type="number" class="tv-block-count" value="1" min="1">
                            </label>
                        </div>
                        <div class="tv-block-range-container hidden">
                            <label>End S: <input type="number" class="tv-block-end-season" value="1" min="1"></label>
                            <label>End E: <input type="number" class="tv-block-end-episode" value="1" min="1"></label>
                        </div>
                        <label class="interleave-label">
                            <input type="checkbox" class="tv-block-interleave" checked> Interleave
                        </label>
                    </div>
                </div>
            </div>
        </details>
    </template>

    <template id="template-tv-show-row">
        <div class="show-row tv-block-show-row">
            <button type="button" class="icon-btn drag-handle" title="Drag to reorder"><i data-feather="move"></i></button>
            <div class="show-select-wrapper">
                <div class="search-and-select">
                    <input type="search" class="show-search-input" placeholder="Filter shows...">
                    <select class="tv-block-show-select"><!-- Options will be populated by JS --></select>
                </div>
                <button type="button" class="icon-btn shuffle-show-btn" title="Pick Random Show"><i data-feather="shuffle"></i></button>
            </div>
            <input type="number" class="tv-block-season" value="1" min="1">
            <input type="number" class="tv-block-episode" value="1" min="1">
            <div class="show-row-controls">
                <button type="button" class="icon-btn random-ep-btn" title="Pick Random Episode"><i data-feather="shuffle"></i></button>
                <button type="button" class="icon-btn danger delete-btn" title="Delete Row"><i data-feather="x"></i></button>
            </div>
            <div class="tv-block-show-options">
                <label>
                    <input type="checkbox" class="first-unwatched-cb"> Start from next unwatched
                </label>
            </div>
            <div class="tv-block-preview"></div>
        </div>
    </template>

    <template id="template-movie-block">
        <details class="mixed-block" data-type="movie" open>
            <summary>
                <div class="mixed-block-header">
                    <button type="button" class="icon-btn drag-handle" title="Drag to reorder"><i data-feather="move"></i></button>
                    <h3><i data-feather="film"></i> Movie Block</h3>
                    <div class="mixed-block-controls">
                        <span class="movie-block-preview-count"></span>
                        <button type="button" class="icon-btn duplicate-block-btn" title="Duplicate Block"><i data-feather="copy"></i></button>
                        <button type="button" class="icon-btn danger delete-block-btn" title="Delete Block"><i data-feather="x"></i></button>
                        <span class="icon-btn collapse-toggle-btn"><i data-feather="chevron-up"></i></span>
                    </div>
                </div>
            </summary>
            <div class="mixed-block-body">
                <fieldset class="filter-group">
                    <legend>Libraries</legend>
                    <div class="checkbox-grid movie-block-libraries"><!-- Library checkboxes will be inserted here --></div>
                </fieldset>
                <fieldset class="filter-group">
                    <legend>Genres</legend>
                    <details>
                        <summary>Expand/Collapse Genre Filters</summary>
                        <div class="token-field-wrapper">
                            <input type="search" class="token-input movie-block-genre-input" placeholder="Search for a genre...">
                            <div class="autocomplete-suggestions"></div>
                        </div>
                        <div class="token-container movie-block-genre-tokens"></div>
                    </details>
                </fieldset>
                <fieldset class="filter-group">
                    <legend>People & Studios</legend>
                    <details>
                        <summary>Expand/Collapse Filters</summary>
                        <div class="token-field-wrapper">
                            <input type="search" class="token-input movie-block-person-input" placeholder="Search for People or Studios...">
                            <div class="autocomplete-suggestions"></div>
                        </div>
                        <div class="token-container movie-block-person-tokens"></div>
                    </details>
                </fieldset>
                <fieldset class="filter-group">
                    <legend>Other Filters</legend>
                    <details>
                        <summary>Expand/Collapse Other Filters</summary>
                        <div class="movie-block-filter-grid">
                            <button type="button" class="filter-toggle-btn movie-block-watched" data-state="all"></button>
                            <button type="button" class="filter-toggle-btn movie-block-sort-by" data-state="Random"></button>
                            <div class="range-slider-wrapper">
                                <div class="range-slider-display">1920 - 2024</div>
                                <div class="range-slider-container">
                                    <div class="range-slider-track"></div>
                                    <div class="range-slider-progress"></div>
                                    <input type="range" class="movie-block-year-from" min="1920">
                                    <input type="range" class="movie-block-year-to" min="1920">
                                </div>
                            </div>
                            <div class="limit-by-wrapper">
                                <label><input type="radio" name="limit-mode" value="count">Count</label>
                                <label><input type="radio" name="limit-mode" value="duration">Duration</label>
                                <div class="input-group">
                                    <input type="number" class="movie-block-limit-value" min="1">
                                    <span class="limit-unit"></span>
                                </div>
                            </div>
                        </div>
                    </details>
                </fieldset>
            </div>
        </details>
    </template>

    <template id="template-music-block">
        <details class="mixed-block" data-type="music" open>
            <summary>
                <div class="mixed-block-header">
                    <button type="button" class="icon-btn drag-handle" title="Drag to reorder"><i data-feather="move"></i></button>
                    <h3><i data-feather="music"></i> Music Block</h3>
                    <div class="mixed-block-controls">
                        <span class="music-block-preview-count"></span>
                        <span class="music-block-preview-summary"></span>
                        <button type="button" class="icon-btn duplicate-block-btn" title="Duplicate Block"><i data-feather="copy"></i></button>
                        <button type="button" class="icon-btn danger delete-block-btn" title="Delete Block"><i data-feather="x"></i></button>
                        <span class="icon-btn collapse-toggle-btn"><i data-feather="chevron-up"></i></span>
                    </div>
                </div>
            </summary>
            <div class="mixed-block-body">
                <label>Mode:
                    <select class="music-block-mode">
                        <option value="album">Add by Album</option>
                        <option value="artist_top">Add by Artist (Top Tracks)</option>
                        <option value="artist_random">Add by Artist (Random)</option>
                        <option value="genre">Add by Genre</option>
                    </select>
                </label>
                <div class="music-artist-container">
                    <div class="music-block-filter-grid">
                        <label>Artist:
                            <input type="search" class="artist-search-input" placeholder="Filter artists...">
                            <select class="music-block-artist"></select>
                        </label>
                        <label class="music-block-album-label">Album:
                            <select class="music-block-album"></select>
                        </label>
                        <label class="music-block-count-label">Track Count:
                            <input type="number" class="music-block-count" value="10" min="1">
                        </label>
                    </div>
                </div>
                <div class="music-genre-container">
                    <fieldset class="filter-group">
                        <legend>Genres</legend>
                        <details>
                            <summary>Expand/Collapse Genre List</summary>
                            <div class="checkbox-grid music-block-genre-grid"></div>
                            <div class="genre-match-toggle"></div>
                        </details>
                    </fieldset>
                    <div class="music-block-filter-grid">
                        <label>Sort By:
                            <select class="music-block-sort-by">
                                <option value="Random">Random</option>
                                <option value="PlayCount">Most Played</option>
                                <option value="DateCreated">Date Added</option>
                                <option value="Name">Name</option>
                            </select>
                        </label>
                        <label>Limit:
                            <input type="number" class="music-block-limit" value="25" min="1">
                        </label>
                    </div>
                </div>
            </div>
        </details>
    </template>
    <!-- ========= END COMPONENT TEMPLATES ========= -->

    <script src="static/vendor/Sortable.min.js"></script>
    <script src="static/vendor/feather.min.js"></script>
    <script>
      function replaceFeatherIcons() {
          feather.replace({
              'stroke-width': 2.5,
              'width': '1.1em',
              'height': '1.1em'
          });
          const wandIcon = document.querySelector('#smart-build-btn .feather-wand');
          if(wandIcon) {
              wandIcon.style.strokeWidth = '3';
              wandIcon.style.marginRight = '0.2rem';
          }
      }
      replaceFeatherIcons();
      window.featherReplace = replaceFeatherIcons;
    </script>
    <script src="static/js/app.js" type="module" defer></script>
</body>
</html>
